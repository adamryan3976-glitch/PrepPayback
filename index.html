function doGet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();
  const data = {};
  
  // 1. Get Cycle Day from the "Cycle Days" sheet
  try {
    const cycleSheet = ss.getSheetByName("Cycle Days");
    data["currentCycleDay"] = cycleSheet.getRange("D1").getDisplayValue().toString().trim();
  } catch(e) {
    data["currentCycleDay"] = "1";
  }

  sheets.forEach(sheet => {
    const sheetName = sheet.getName();
    const exclude = ["TEMPLATE", "MOD", "Language", "Dropdowns", "Staff", "REG", "Cycle Days", "Prep Paybacks"];
    if (exclude.includes(sheetName)) return;

    const displayName = sheet.getRange("A1").getValue().toString().trim() || sheetName;
    const assignment = sheet.getRange("A2").getValue().toString().trim() || "";
    
    const scheduleRange = sheet.getRange("B3:F12").getValues();
    const schedule = { "1":[], "2":[], "3":[], "4":[], "5":[] };

    for (let row = 0; row < 10; row++) {
      schedule["1"].push(scheduleRange[row][0]?.toString().trim() || "");
      schedule["2"].push(scheduleRange[row][1]?.toString().trim() || "");
      schedule["3"].push(scheduleRange[row][2]?.toString().trim() || "");
      schedule["4"].push(scheduleRange[row][3]?.toString().trim() || "");
      schedule["5"].push(scheduleRange[row][4]?.toString().trim() || "");
    }

    data[sheetName] = {
      displayName: displayName,
      assignment: assignment,
      schedule: schedule
    };
  });

  // 2. Include Prep Payback Data using specific column headers provided
  try {
    const paybackSheet = ss.getSheetByName("Prep Paybacks");
    const pbValues = paybackSheet.getDataRange().getValues();
    const headers = pbValues[0];
    
    const staffIdx = headers.indexOf("Staff");
    const balanceIdx = headers.indexOf("Balance");

    data["Prep Paybacks"] = pbValues.slice(1).map(row => ({
      Staff: row[staffIdx],
      Balance: row[balanceIdx]
    })).filter(row => row.Staff); // Filter empty rows
  } catch(e) {
    data["Prep Paybacks"] = [];
  }

  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Handle updates from the Web App
 */
function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Prep Paybacks");
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    // Column Names: Staff, Preps Stolen, Preps Paid Back, Balance
    const staffCol = headers.indexOf("Staff") + 1;
    const stolenCol = headers.indexOf("Preps Stolen") + 1;
    const paybackCol = headers.indexOf("Preps Paid Back") + 1;
    
    if (staffCol === 0 || (params.type === 'steal' && stolenCol === 0) || (params.type === 'payback' && paybackCol === 0)) {
      throw new Error("Required columns not found in Prep Paybacks sheet");
    }

    // Find the row for this staff member
    let rowFound = -1;
    for (let i = 1; i < data.length; i++) {
      if (data[i][staffCol - 1].toString().trim() === params.staffId.toString().trim()) {
        rowFound = i + 1;
        break;
      }
    }

    if (rowFound !== -1) {
      const targetCol = params.type === 'steal' ? stolenCol : paybackCol;
      const currentVal = sheet.getRange(rowFound, targetCol).getValue() || 0;
      sheet.getRange(rowFound, targetCol).setValue(Number(currentVal) + 1);
      
      return ContentService.createTextOutput(JSON.stringify({ status: "success" }))
        .setMimeType(ContentService.MimeType.JSON);
    } else {
      return ContentService.createTextOutput(JSON.stringify({ status: "error", message: "Staff '" + params.staffId + "' not found in Prep Paybacks sheet" }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
